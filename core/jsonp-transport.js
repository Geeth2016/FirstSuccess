var Montage=require("montage/core/core").Montage,Params=require("query-params"),Url=require("url"),Uuid=require("montage/core/uuid"),Promise=require("montage/core/promise").Promise;exports.JsonpTransport=Montage.specialize({constructor:{value:function(){}},makeRequest:{value:function(e,r,o){var n,t=Promise.defer(),l=this,a=Url.parse(e),c=Params.decode(a.query),i=r?r+"ServiceCallback":"serviceCallback",u=i+Uuid.generate().replace(/-/g,"_"),s=document.createElement("script");return window[u]=function(e){l._handleResponse(e,t),document.head.removeChild(s),delete window[u]},c[o?o:"callback"]=u,n=e.replace(a.query,"")+Params.encode(c),s.src=n,document.head.appendChild(s),t.promise}},_handleResponse:{value:function(e,r){e?e.error?r.reject(Error(e.error)):r.resolve(e):r.reject(Error("Unknown API Error"))}}}),exports.shared=new exports.JsonpTransport;