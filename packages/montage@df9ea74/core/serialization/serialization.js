var Montage=require("../core").Montage,MontageLabeler=require("./serializer/montage-labeler").MontageLabeler,MontageReviver=require("./deserializer/montage-reviver").MontageReviver,parse=require("frb/parse"),stringify=require("frb/stringify"),Serialization=Montage.specialize({_serializationString:{value:null},_serializationObject:{value:null},_serializationLabels:{value:null},initWithString:{value:function(e){return this._serializationString=e,this._serializationObject=null,this._serializationLabels=null,this}},initWithObject:{value:function(e){return this._serializationString=null,this._serializationObject=e,this._serializationLabels=null,this}},clone:{value:function(){var e=new Serialization;return e.initWithString(this.getSerializationString()),e}},getSerializationObject:{value:function(){return this._serializationObject||(this._serializationObject=JSON.parse(this._serializationString)),this._serializationObject}},getSerializationString:{value:function(){return this._serializationString||(this._serializationString=JSON.stringify(this._serializationObject)),this._serializationString}},getSerializationLabels:{value:function(){var e;return this._serializationLabels||(e=this.getSerializationObject())&&(this._serializationLabels=Object.keys(e)),this._serializationLabels}},getExternalObjectLabels:{value:function(){var e=this.getSerializationObject(),t=[];for(var n in e)0===Object.keys(e[n]).length&&t.push(n);return t}},hasSerializationLabel:{value:function(e){return e in this.getSerializationObject()}},isExternalObject:{value:function(e){var t=this.getSerializationObject();return t&&e in t?0===Object.keys(t[e]).length:!1}},isAlias:{value:function(e){var t=this.getSerializationObject();return t&&e in t?"alias"in t[e]:!1}},getElementId:{value:function(e){var t=this.getSerializationObject(),n=Montage.getPath.call(t,e+".properties.element");return n?n["#"]:void 0}},getSerializationLabelsWithElements:{value:function(e){var t=new SerializationInspector,n=[];return t.initWithSerialization(this),t.visitSerialization(function(t){"Element"===t.type&&e.indexOf(t.data)>=0&&(t=t.parent,t&&"properties"===t.name&&(t=t.parent,t&&"montageObject"===t.type&&n.push(t.label)))}),n}},renameElementReferences:{value:function(e){var t=new SerializationInspector;t.initWithSerialization(this),t.visitSerialization(function(t){"Element"===t.type&&t.data in e&&(t.data=e[t.data])})}},renameSerializationLabels:{value:function(e){var t=new SerializationInspector;t.initWithSerialization(this),t.visitSerialization(function(t){if(t.label){var n=t.label;n in e&&(t.label=e[n])}if("reference"===t.type){var r=t.data;r in e&&(t.data=e[r])}})}},mergeSerialization:{value:function(e,t){return SerializationMerger.mergeSerializations(this,e,t)}},extractSerialization:{value:function(e,t){var n=new SerializationExtractor;return n.initWithSerialization(this),n.extractSerialization(e,t)}}}),SerializationMerger=Montage.specialize(null,{mergeSerializations:{value:function(e,t,n){var r,i,o,a,s,l,u={};o=e.getSerializationLabels(),a=t.getSerializationLabels(),s=this._createCollisionTable(o,a,u,n&&n.labeler),n&&n.willMergeObjectWithLabel&&(l=this._willMergeObjectWithLabel(n,e,t,u),s=s||l),s&&(t=t.clone(),t.renameSerializationLabels(u),a=t.getSerializationLabels()),r=e.getSerializationObject(),i=t.getSerializationObject();for(var c,d=0;c=a[d];d++)-1===o.indexOf(c)&&(r[c]=i[c]);return e.initWithObject(r),u}},_willMergeObjectWithLabel:{value:function(e,t,n,r){var i,o,a,s,l,u=!1,c=n.getSerializationLabels();r&&(a=[],Object.keys(r).forEach(function(e){a.push(r[e])}));for(var d,h=0;d=c[h];h++)if(o=r&&r[d],i=e.willMergeObjectWithLabel(d,o),"string"==typeof i){if(s=this._isLabelValidInSerialization(i,t),s||(l=!this._isLabelValidInSerialization(i,n)&&-1===a.indexOf(i)),!s&&!l)throw Error("willMergeObjectWithLabel either needs to return a label that exists in the destination serialization to indicate it's the same object or return a completely new label to rename the object being merged. \""+i+'"  destination: '+t.getSerializationString()+"\n source: "+n.getSerializationString()+"\n collision table: "+JSON.stringify(r,null,4));u=!0,r[d]=i}return u}},_isLabelValidInSerialization:{value:function(e,t){var n,r;return t.hasSerializationLabel(e)?!0:(r=e.indexOf(":"),r>0&&(n=e.slice(0,r),t.hasSerializationLabel(n))?!0:!1)}},_createCollisionTable:{value:function(e,t,n,r){for(var i,o,a,s,r=r||new MontageLabeler,l=!1,u=Object.create(null),c=0;e.length>c;c++)a=e[c],s=a.indexOf(":"),s>0&&(i=a.slice(0,s),r.addLabel(i),u[i]=1),r.addLabel(a),u[a]=1;for(var c=0;a=t[c];c++)s=a.indexOf(":"),s>0?(i=a.slice(0,s),o=n[i],o?(n[a]=o+":"+a.slice(s+1),l=!0):i in u?(o=r.generateLabel(r.getLabelBaseName(i)),t.indexOf(i)>=0&&(n[i]=o),n[a]=o+a.slice(s),l=!0):r.addLabel(i)):a in u&&!(a in n)?(n[a]=r.generateLabel(r.getLabelBaseName(a)),l=!0):r.addLabel(a);return l}}}),SerializationInspector=Montage.specialize({initWithSerialization:{value:function(e){this._serialization=e}},visitSerialization:{value:function(e){var t=this._serialization.getSerializationObject();this._walkRootObjects(e,t),this._serialization.initWithObject(t)}},visitSerializationObject:{value:function(e,t){var n=this._serialization.getSerializationObject();if(!(e in n))throw Error('Object "'+e+'" does not exist in '+this._serialization.getSerializationString());this._walkRootObject(t,n,e),this._serialization.initWithObject(n)}},changeLabel:{value:function(e,t){var n,r=this._serialization.getSerializationObject();n=r[e],delete r[e],r[t]=n}},_walkRootObjects:{value:function(e,t){for(var n in t)this._walkRootObject(e,t,n)}},_walkRootObject:{value:function(e,t,n){var r=t[n];"value"in r?this._walkObject(e,r,"value",n):this._walkCustomObject(e,t,n)}},_walkObject:{value:function(e,t,n,r,i){var o,a=t[n],s=MontageReviver.getTypeOf(a);if(o={type:s},r?o.label=r:o.name=n,i&&(o.parent=i),"number"===s||"string"===s||"null"===s)o.data=a,e(o),t[n]=o.data;else if("regexp"===s)o.data=a["/"],e(o),a["/"]=o.data;else if("reference"===s)o.data=a["@"],e(o),a["@"]=o.data;else if("Element"===s)o.data=a["#"],e(o),a["#"]=o.data;else if("array"===s){o.data=a,e(o),t[n]=a=o.data;for(var l=0,u=a.length;u>l;l++)this._walkObject(e,a,""+l,null,o)}else if("object"===s){o.data=a,e(o),t[n]=a=o.data;for(var n in a)this._walkObject(e,a,n,null,o)}o.label!=r&&this.changeLabel(r,o.label)}},_walkCustomObject:{value:function(e,t,n){var r,i=t[n];r={type:"montageObject",label:n,data:i},e(r),t[n]=i=r.data,r.label!=n&&this.changeLabel(n,r.label),i.properties&&this._walkObject(e,i,"properties",null,r),i.listeners&&this._walkObject(e,i,"listeners",null,r),i.bindings&&this._walkBindings(e,i,null,r),i.localizations&&this._walkLocalizations(e,i,null,r)}},_walkBindings:{value:function(e,t,n){var r,i=t.bindings;r={type:"bindings",data:i,parent:n},e(r),t.bindings=i=r.data;for(var o in i)this._walkBinding(e,i,o,r)}},_walkBinding:{value:function(e,t,n,r){var i,o=t[n];i={type:"binding",name:n,data:o,parent:r},e(i),t[n]=o=i.data,this._walkBindingData(e,o,i)}},_walkBindingData:{value:function(e,t,n){var r,i,o=!1;r=t["<-"]||t["<->"],i=Object.clone(parse(r)),this._walksBindingReferences(i,function(t){var n={type:"reference",data:t.label};e(n),t.label!==n.data&&(t.label=n.data,o=!0)}),o&&("<-"in t?t["<-"]=stringify(i):t["<->"]=stringify(i)),t.converter&&this._walkObject(e,t,"converter",null,n)}},_walkLocalizations:{value:function(e,t,n){var r,i=t.localizations;r={type:"localizations",data:i,parent:n},e(r),t.localizations=i=r.data;for(var o in i)this._walkLocalization(e,i,o,r)}},_walkLocalization:{value:function(e,t,n,r){var i,o,a=t[n];if(i={type:"localization",name:n,data:a,parent:r},e(i),t[n]=a=i.data,"object"==typeof a.key&&this._walkBindingData(e,a.key,i),"object"==typeof a.default&&this._walkBindingData(e,a.default,i),"object"==typeof a.data){o=a.data;for(var n in o)this._walkBindingData(e,o[n],i)}}},_walksBindingReferences:{value:function(e,t){var n=e.args;if("component"===e.type&&t(e),n)for(var r=0,i=n.length;i>r;r++)this._walksBindingReferences(n[r],t)}}}),SerializationExtractor=Montage.specialize({_serialization:{value:null},initWithSerialization:{value:function(e){this._serialization=e}},extractSerialization:{value:function(e,t){var n,r=new SerializationInspector,i={},o=[];n=this._serialization.getSerializationObject(),r.initWithSerialization(this._serialization);for(var a,s=0;a=e[s];s++)i[a]=n[a],r.visitSerializationObject(a,function(t){var n;"reference"===t.type&&(n=t.data,-1===o.indexOf(n)&&-1===e.indexOf(n)&&o.push(n))});if(t)for(var a,s=0;a=t[s];s++)a in n&&!(a in i)&&(i[a]={});for(var a,s=0;a=o[s];s++)i[a]={};return(new Serialization).initWithObject(i)}}});exports.Serialization=Serialization,exports.SerializationMerger=SerializationMerger,exports.SerializationInspector=SerializationInspector,exports.SerializationExtractor=SerializationExtractor;